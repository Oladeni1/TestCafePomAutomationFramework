"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../../../../shared/errors/index");
const utils_1 = require("./utils");
// @ts-ignore
const hammerhead_1 = require("../../../deps/hammerhead");
const SELECTOR_FILTER_ERROR = {
    filterVisible: 1,
    filterHidden: 2,
    nth: 3,
};
const FILTER_ERROR_TO_API_RE = {
    [SELECTOR_FILTER_ERROR.filterVisible]: /^\.filterVisible\(\)$/,
    [SELECTOR_FILTER_ERROR.filterHidden]: /^\.filterHidden\(\)$/,
    [SELECTOR_FILTER_ERROR.nth]: /^\.nth\(\d+\)$/,
};
class SelectorFilter {
    constructor() {
        this._err = null;
    }
    get error() {
        return this._err;
    }
    set error(message) {
        if (this._err === null)
            this._err = message;
    }
    filter(nodes, options, apiInfo) {
        if (options.filterVisible) {
            nodes = nodes.filter(utils_1.visible);
            this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.filterVisible);
        }
        if (options.filterHidden) {
            nodes = nodes.filter(n => !(0, utils_1.visible)(n));
            this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.filterHidden);
        }
        if (options.counterMode) {
            if (options.index === null)
                return nodes.length;
            return SelectorFilter._getNodeByIndex(nodes, options.index) ? 1 : 0;
        }
        if (options.collectionMode) {
            if (options.index !== null) {
                const nodeOnIndex = SelectorFilter._getNodeByIndex(nodes, options.index);
                nodes = nodeOnIndex ? [nodeOnIndex] : [];
                this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.nth);
            }
            return nodes;
        }
        const nodeOnIndex = SelectorFilter._getNodeByIndex(nodes, options.index || 0);
        if (!nodeOnIndex)
            this.error = SelectorFilter._getErrorItem(apiInfo, SELECTOR_FILTER_ERROR.nth);
        return nodeOnIndex;
    }
    cast(searchResult) {
        if (searchResult === null || searchResult === void 0)
            return [];
        else if (searchResult instanceof hammerhead_1.nativeMethods.Node)
            return [searchResult];
        else if ((0, utils_1.isArrayOfNodes)(searchResult))
            return searchResult;
        else if ((0, utils_1.isNodeCollection)(searchResult))
            return (0, utils_1.castToArray)(searchResult);
        throw new index_1.InvalidSelectorResultError();
    }
    _assertFilterError(filtered, apiInfo, filterError) {
        if (filtered.length === 0)
            this.error = SelectorFilter._getErrorItem(apiInfo, filterError);
    }
    static _getErrorItem({ apiFnChain, apiFnID }, err) {
        if (err) {
            for (let i = apiFnID; i < apiFnChain.length; i++) {
                if (FILTER_ERROR_TO_API_RE[err].test(apiFnChain[i]))
                    return i;
            }
        }
        return null;
    }
    static _getNodeByIndex(nodes, index) {
        return index < 0 ? nodes[nodes.length + index] : nodes[index];
    }
}
exports.default = new SelectorFilter();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9kcml2ZXIvY29tbWFuZC1leGVjdXRvcnMvY2xpZW50LWZ1bmN0aW9ucy9zZWxlY3Rvci1leGVjdXRvci9maWx0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4REFBZ0Y7QUFDaEYsbUNBS2lCO0FBRWpCLGFBQWE7QUFDYix5REFBeUQ7QUFHekQsTUFBTSxxQkFBcUIsR0FBRztJQUMxQixhQUFhLEVBQUUsQ0FBQztJQUNoQixZQUFZLEVBQUcsQ0FBQztJQUNoQixHQUFHLEVBQVksQ0FBQztDQUNuQixDQUFDO0FBRUYsTUFBTSxzQkFBc0IsR0FBRztJQUMzQixDQUFDLHFCQUFxQixDQUFDLGFBQWEsQ0FBQyxFQUFFLHVCQUF1QjtJQUM5RCxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxFQUFHLHNCQUFzQjtJQUM3RCxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxFQUFZLGdCQUFnQjtDQUMxRCxDQUFDO0FBR0YsTUFBTSxjQUFjO0lBQXBCO1FBQ1ksU0FBSSxHQUFrQixJQUFJLENBQUM7SUFzRnZDLENBQUM7SUFwRkcsSUFBVyxLQUFLO1FBQ1osT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxJQUFXLEtBQUssQ0FBRSxPQUFzQjtRQUNwQyxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssSUFBSTtZQUNsQixJQUFJLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztJQUM1QixDQUFDO0lBRU0sTUFBTSxDQUFFLEtBQWEsRUFBRSxPQUFzQixFQUFFLE9BQWdCO1FBQ2xFLElBQUksT0FBTyxDQUFDLGFBQWEsRUFBRTtZQUN2QixLQUFLLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxlQUFPLENBQUMsQ0FBQztZQUU5QixJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxxQkFBcUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNoRjtRQUVELElBQUksT0FBTyxDQUFDLFlBQVksRUFBRTtZQUN0QixLQUFLLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBQSxlQUFPLEVBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUV2QyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxxQkFBcUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUMvRTtRQUVELElBQUksT0FBTyxDQUFDLFdBQVcsRUFBRTtZQUNyQixJQUFJLE9BQU8sQ0FBQyxLQUFLLEtBQUssSUFBSTtnQkFDdEIsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBRXhCLE9BQU8sY0FBYyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN2RTtRQUVELElBQUksT0FBTyxDQUFDLGNBQWMsRUFBRTtZQUN4QixJQUFJLE9BQU8sQ0FBQyxLQUFLLEtBQUssSUFBSSxFQUFFO2dCQUN4QixNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBRXpFLEtBQUssR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFFekMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUscUJBQXFCLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDdEU7WUFFRCxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUVELE1BQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFOUUsSUFBSSxDQUFDLFdBQVc7WUFDWixJQUFJLENBQUMsS0FBSyxHQUFHLGNBQWMsQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWxGLE9BQU8sV0FBVyxDQUFDO0lBQ3ZCLENBQUM7SUFFTSxJQUFJLENBQUUsWUFBcUI7UUFDOUIsSUFBSSxZQUFZLEtBQUssSUFBSSxJQUFJLFlBQVksS0FBSyxLQUFLLENBQUM7WUFDaEQsT0FBTyxFQUFFLENBQUM7YUFFVCxJQUFJLFlBQVksWUFBWSwwQkFBYSxDQUFDLElBQUk7WUFDL0MsT0FBTyxDQUFDLFlBQW9CLENBQUMsQ0FBQzthQUU3QixJQUFJLElBQUEsc0JBQWMsRUFBQyxZQUFZLENBQUM7WUFDakMsT0FBTyxZQUFZLENBQUM7YUFFbkIsSUFBSSxJQUFBLHdCQUFnQixFQUFDLFlBQVksQ0FBQztZQUNuQyxPQUFPLElBQUEsbUJBQVcsRUFBQyxZQUFZLENBQUMsQ0FBQztRQUVyQyxNQUFNLElBQUksa0NBQTBCLEVBQUUsQ0FBQztJQUMzQyxDQUFDO0lBRU8sa0JBQWtCLENBQUUsUUFBZ0IsRUFBRSxPQUFnQixFQUFFLFdBQW1CO1FBQy9FLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQ3JCLElBQUksQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUVPLE1BQU0sQ0FBQyxhQUFhLENBQUUsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFXLEVBQUUsR0FBVztRQUN2RSxJQUFJLEdBQUcsRUFBRTtZQUNMLEtBQUssSUFBSSxDQUFDLEdBQUcsT0FBTyxFQUFFLENBQUMsR0FBRyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUM5QyxJQUFJLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQy9DLE9BQU8sQ0FBQyxDQUFDO2FBQ2hCO1NBQ0o7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRU8sTUFBTSxDQUFDLGVBQWUsQ0FBRSxLQUFhLEVBQUUsS0FBYTtRQUN4RCxPQUFPLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEUsQ0FBQztDQUNKO0FBRUQsa0JBQWUsSUFBSSxjQUFjLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEludmFsaWRTZWxlY3RvclJlc3VsdEVycm9yIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vc2hhcmVkL2Vycm9ycy9pbmRleCc7XG5pbXBvcnQge1xuICAgIHZpc2libGUsXG4gICAgaXNOb2RlQ29sbGVjdGlvbixcbiAgICBpc0FycmF5T2ZOb2RlcyxcbiAgICBjYXN0VG9BcnJheSxcbn0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBBUElJbmZvLCBGaWx0ZXJPcHRpb25zIH0gZnJvbSAnLi4vdHlwZXMnO1xuLy8gQHRzLWlnbm9yZVxuaW1wb3J0IHsgbmF0aXZlTWV0aG9kcyB9IGZyb20gJy4uLy4uLy4uL2RlcHMvaGFtbWVyaGVhZCc7XG5cblxuY29uc3QgU0VMRUNUT1JfRklMVEVSX0VSUk9SID0ge1xuICAgIGZpbHRlclZpc2libGU6IDEsXG4gICAgZmlsdGVySGlkZGVuOiAgMixcbiAgICBudGg6ICAgICAgICAgICAzLFxufTtcblxuY29uc3QgRklMVEVSX0VSUk9SX1RPX0FQSV9SRSA9IHtcbiAgICBbU0VMRUNUT1JfRklMVEVSX0VSUk9SLmZpbHRlclZpc2libGVdOiAvXlxcLmZpbHRlclZpc2libGVcXChcXCkkLyxcbiAgICBbU0VMRUNUT1JfRklMVEVSX0VSUk9SLmZpbHRlckhpZGRlbl06ICAvXlxcLmZpbHRlckhpZGRlblxcKFxcKSQvLFxuICAgIFtTRUxFQ1RPUl9GSUxURVJfRVJST1IubnRoXTogICAgICAgICAgIC9eXFwubnRoXFwoXFxkK1xcKSQvLFxufTtcblxuXG5jbGFzcyBTZWxlY3RvckZpbHRlciB7XG4gICAgcHJpdmF0ZSBfZXJyOiBudW1iZXIgfCBudWxsID0gbnVsbDtcblxuICAgIHB1YmxpYyBnZXQgZXJyb3IgKCk6IG51bWJlciB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXJyO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgZXJyb3IgKG1lc3NhZ2U6IG51bWJlciB8IG51bGwpIHtcbiAgICAgICAgaWYgKHRoaXMuX2VyciA9PT0gbnVsbClcbiAgICAgICAgICAgIHRoaXMuX2VyciA9IG1lc3NhZ2U7XG4gICAgfVxuXG4gICAgcHVibGljIGZpbHRlciAobm9kZXM6IE5vZGVbXSwgb3B0aW9uczogRmlsdGVyT3B0aW9ucywgYXBpSW5mbzogQVBJSW5mbyk6IG51bWJlciB8IE5vZGUgfCBOb2RlW10gfCB1bmRlZmluZWQge1xuICAgICAgICBpZiAob3B0aW9ucy5maWx0ZXJWaXNpYmxlKSB7XG4gICAgICAgICAgICBub2RlcyA9IG5vZGVzLmZpbHRlcih2aXNpYmxlKTtcblxuICAgICAgICAgICAgdGhpcy5fYXNzZXJ0RmlsdGVyRXJyb3Iobm9kZXMsIGFwaUluZm8sIFNFTEVDVE9SX0ZJTFRFUl9FUlJPUi5maWx0ZXJWaXNpYmxlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLmZpbHRlckhpZGRlbikge1xuICAgICAgICAgICAgbm9kZXMgPSBub2Rlcy5maWx0ZXIobiA9PiAhdmlzaWJsZShuKSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2Fzc2VydEZpbHRlckVycm9yKG5vZGVzLCBhcGlJbmZvLCBTRUxFQ1RPUl9GSUxURVJfRVJST1IuZmlsdGVySGlkZGVuKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLmNvdW50ZXJNb2RlKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5pbmRleCA9PT0gbnVsbClcbiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZXMubGVuZ3RoO1xuXG4gICAgICAgICAgICByZXR1cm4gU2VsZWN0b3JGaWx0ZXIuX2dldE5vZGVCeUluZGV4KG5vZGVzLCBvcHRpb25zLmluZGV4KSA/IDEgOiAwO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbk1vZGUpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmluZGV4ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZU9uSW5kZXggPSBTZWxlY3RvckZpbHRlci5fZ2V0Tm9kZUJ5SW5kZXgobm9kZXMsIG9wdGlvbnMuaW5kZXgpO1xuXG4gICAgICAgICAgICAgICAgbm9kZXMgPSBub2RlT25JbmRleCA/IFtub2RlT25JbmRleF0gOiBbXTtcblxuICAgICAgICAgICAgICAgIHRoaXMuX2Fzc2VydEZpbHRlckVycm9yKG5vZGVzLCBhcGlJbmZvLCBTRUxFQ1RPUl9GSUxURVJfRVJST1IubnRoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG5vZGVzO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgbm9kZU9uSW5kZXggPSBTZWxlY3RvckZpbHRlci5fZ2V0Tm9kZUJ5SW5kZXgobm9kZXMsIG9wdGlvbnMuaW5kZXggfHwgMCk7XG5cbiAgICAgICAgaWYgKCFub2RlT25JbmRleClcbiAgICAgICAgICAgIHRoaXMuZXJyb3IgPSBTZWxlY3RvckZpbHRlci5fZ2V0RXJyb3JJdGVtKGFwaUluZm8sIFNFTEVDVE9SX0ZJTFRFUl9FUlJPUi5udGgpO1xuXG4gICAgICAgIHJldHVybiBub2RlT25JbmRleDtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2FzdCAoc2VhcmNoUmVzdWx0OiB1bmtub3duKTogTm9kZVtdIHtcbiAgICAgICAgaWYgKHNlYXJjaFJlc3VsdCA9PT0gbnVsbCB8fCBzZWFyY2hSZXN1bHQgPT09IHZvaWQgMClcbiAgICAgICAgICAgIHJldHVybiBbXTtcblxuICAgICAgICBlbHNlIGlmIChzZWFyY2hSZXN1bHQgaW5zdGFuY2VvZiBuYXRpdmVNZXRob2RzLk5vZGUpXG4gICAgICAgICAgICByZXR1cm4gW3NlYXJjaFJlc3VsdCBhcyBOb2RlXTtcblxuICAgICAgICBlbHNlIGlmIChpc0FycmF5T2ZOb2RlcyhzZWFyY2hSZXN1bHQpKVxuICAgICAgICAgICAgcmV0dXJuIHNlYXJjaFJlc3VsdDtcblxuICAgICAgICBlbHNlIGlmIChpc05vZGVDb2xsZWN0aW9uKHNlYXJjaFJlc3VsdCkpXG4gICAgICAgICAgICByZXR1cm4gY2FzdFRvQXJyYXkoc2VhcmNoUmVzdWx0KTtcblxuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFNlbGVjdG9yUmVzdWx0RXJyb3IoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9hc3NlcnRGaWx0ZXJFcnJvciAoZmlsdGVyZWQ6IE5vZGVbXSwgYXBpSW5mbzogQVBJSW5mbywgZmlsdGVyRXJyb3I6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBpZiAoZmlsdGVyZWQubGVuZ3RoID09PSAwKVxuICAgICAgICAgICAgdGhpcy5lcnJvciA9IFNlbGVjdG9yRmlsdGVyLl9nZXRFcnJvckl0ZW0oYXBpSW5mbywgZmlsdGVyRXJyb3IpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9nZXRFcnJvckl0ZW0gKHsgYXBpRm5DaGFpbiwgYXBpRm5JRCB9OiBBUElJbmZvLCBlcnI6IG51bWJlcik6IG51bWJlciB8IG51bGwge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gYXBpRm5JRDsgaSA8IGFwaUZuQ2hhaW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoRklMVEVSX0VSUk9SX1RPX0FQSV9SRVtlcnJdLnRlc3QoYXBpRm5DaGFpbltpXSkpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldE5vZGVCeUluZGV4IChub2RlczogTm9kZVtdLCBpbmRleDogbnVtYmVyKTogTm9kZSB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiBpbmRleCA8IDAgPyBub2Rlc1tub2Rlcy5sZW5ndGggKyBpbmRleF0gOiBub2Rlc1tpbmRleF07XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBuZXcgU2VsZWN0b3JGaWx0ZXIoKTtcbiJdfQ==
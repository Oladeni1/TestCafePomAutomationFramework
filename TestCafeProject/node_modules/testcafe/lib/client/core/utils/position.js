"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.isElementVisible = exports.isIframeVisible = exports.getWindowPosition = exports.isInRectangle = exports.getClientPosition = exports.findCenter = exports.getIframePointRelativeToParentFrame = exports.getEventPageCoordinates = exports.getEventAbsoluteCoordinates = exports.containsOffset = exports.getIframeClientCoordinates = exports.calcRelativePosition = exports.getElementFromPoint = exports.getClientDimensions = exports.offsetToClientCoords = exports.getOffsetPosition = exports.getElementRectangle = void 0;
const hammerhead_1 = __importDefault(require("../deps/hammerhead"));
const styleUtils = __importStar(require("./style"));
const domUtils = __importStar(require("./dom"));
const axis_values_1 = __importDefault(require("./values/axis-values"));
const boundary_values_1 = __importDefault(require("./values/boundary-values"));
const dimensions_1 = __importDefault(require("./values/dimensions"));
exports.getElementRectangle = hammerhead_1.default.utils.position.getElementRectangle;
exports.getOffsetPosition = hammerhead_1.default.utils.position.getOffsetPosition;
exports.offsetToClientCoords = hammerhead_1.default.utils.position.offsetToClientCoords;
function getClientDimensions(target) {
    const isHtmlElement = domUtils.isHtmlElement(target);
    const body = isHtmlElement ? target.getElementsByTagName('body')[0] : null;
    const elementRect = target.getBoundingClientRect();
    const elBorders = boundary_values_1.default.create(styleUtils.getBordersWidth(target));
    const elScroll = styleUtils.getElementScroll(target);
    const isElementInIframe = domUtils.isElementInIframe(target);
    const isCompatMode = target.ownerDocument.compatMode === 'BackCompat';
    const elPosition = isHtmlElement ? new axis_values_1.default(0, 0) : axis_values_1.default.create(elementRect);
    let elHeight = elementRect.height;
    let elWidth = elementRect.width;
    if (isHtmlElement) {
        if (body && isCompatMode) {
            elHeight = body.clientHeight;
            elWidth = body.clientWidth;
        }
        else {
            elHeight = target.clientHeight;
            elWidth = target.clientWidth;
        }
    }
    if (isElementInIframe) {
        const iframeElement = domUtils.getIframeByElement(target);
        if (iframeElement) {
            const iframeOffset = (0, exports.getOffsetPosition)(iframeElement);
            const clientOffset = (0, exports.offsetToClientCoords)(axis_values_1.default.create(iframeOffset));
            const iframeBorders = styleUtils.getBordersWidth(iframeElement);
            elPosition.add(clientOffset).add(axis_values_1.default.create(iframeBorders));
            if (isHtmlElement)
                elBorders.add(iframeBorders);
        }
    }
    const hasRightScrollbar = !isHtmlElement && styleUtils.getInnerWidth(target) !== target.clientWidth;
    const hasBottomScrollbar = !isHtmlElement && styleUtils.getInnerHeight(target) !== target.clientHeight;
    const scrollbar = {
        right: hasRightScrollbar ? domUtils.getScrollbarSize() : 0,
        bottom: hasBottomScrollbar ? domUtils.getScrollbarSize() : 0,
    };
    return new dimensions_1.default(elWidth, elHeight, elPosition, elBorders, elScroll, scrollbar);
}
exports.getClientDimensions = getClientDimensions;
function getElementFromPoint({ x, y }) {
    // @ts-ignore
    const ieFn = document.getElementFromPoint;
    const func = ieFn || document.elementFromPoint;
    let el = null;
    try {
        // Permission denied to access property 'getElementFromPoint' error in iframe
        el = func.call(document, x, y);
    }
    catch (_a) {
        return null;
    }
    //NOTE: elementFromPoint returns null when is's a border of an iframe
    if (el === null)
        el = func.call(document, x - 1, y - 1);
    while (el && el.shadowRoot && el.shadowRoot.elementFromPoint) {
        const shadowEl = el.shadowRoot.elementFromPoint(x, y);
        if (!shadowEl || el === shadowEl)
            break;
        el = shadowEl;
    }
    return el;
}
exports.getElementFromPoint = getElementFromPoint;
function calcRelativePosition(dimensions, toDimensions) {
    const pos = boundary_values_1.default.create({
        top: dimensions.top - toDimensions.top,
        left: dimensions.left - toDimensions.left,
        right: toDimensions.right - dimensions.right,
        bottom: toDimensions.bottom - dimensions.bottom,
    });
    return pos.sub(toDimensions.border).sub(toDimensions.scrollbar).round(Math.ceil, Math.floor);
}
exports.calcRelativePosition = calcRelativePosition;
function getIframeClientCoordinates(iframe) {
    const { left, top } = (0, exports.getOffsetPosition)(iframe);
    const clientPosition = (0, exports.offsetToClientCoords)({ x: left, y: top });
    const iframeBorders = styleUtils.getBordersWidth(iframe);
    const iframePadding = styleUtils.getElementPadding(iframe);
    const iframeRectangleLeft = clientPosition.x + iframeBorders.left + iframePadding.left;
    const iframeRectangleTop = clientPosition.y + iframeBorders.top + iframePadding.top;
    return new boundary_values_1.default(iframeRectangleTop, iframeRectangleLeft + styleUtils.getWidth(iframe), iframeRectangleTop + styleUtils.getHeight(iframe), iframeRectangleLeft);
}
exports.getIframeClientCoordinates = getIframeClientCoordinates;
function containsOffset(el, offsetX, offsetY) {
    const dimensions = getClientDimensions(el);
    const width = Math.max(el.scrollWidth, dimensions.width);
    const height = Math.max(el.scrollHeight, dimensions.height);
    const maxX = dimensions.scrollbar.right + dimensions.border.left + dimensions.border.right + width;
    const maxY = dimensions.scrollbar.bottom + dimensions.border.top + dimensions.border.bottom + height;
    return (typeof offsetX === 'undefined' || offsetX >= 0 && maxX >= offsetX) &&
        (typeof offsetY === 'undefined' || offsetY >= 0 && maxY >= offsetY);
}
exports.containsOffset = containsOffset;
function getEventAbsoluteCoordinates(ev) {
    const el = ev.target || ev.srcElement;
    const pageCoordinates = getEventPageCoordinates(ev);
    const curDocument = domUtils.findDocument(el);
    let xOffset = 0;
    let yOffset = 0;
    if (domUtils.isElementInIframe(curDocument.documentElement)) {
        const currentIframe = domUtils.getIframeByElement(curDocument);
        if (currentIframe) {
            const iframeOffset = (0, exports.getOffsetPosition)(currentIframe);
            const iframeBorders = styleUtils.getBordersWidth(currentIframe);
            xOffset = iframeOffset.left + iframeBorders.left;
            yOffset = iframeOffset.top + iframeBorders.top;
        }
    }
    return new axis_values_1.default(pageCoordinates.x + xOffset, pageCoordinates.y + yOffset);
}
exports.getEventAbsoluteCoordinates = getEventAbsoluteCoordinates;
function getEventPageCoordinates(ev) {
    const curCoordObject = /^touch/.test(ev.type) && ev.targetTouches ? ev.targetTouches[0] || ev.changedTouches[0] : ev;
    const bothPageCoordinatesAreZero = curCoordObject.pageX === 0 && curCoordObject.pageY === 0;
    const notBothClientCoordinatesAreZero = curCoordObject.clientX !== 0 || curCoordObject.clientY !== 0;
    if ((curCoordObject.pageX === null || bothPageCoordinatesAreZero && notBothClientCoordinatesAreZero) &&
        curCoordObject.clientX !== null) {
        const currentDocument = domUtils.findDocument(ev.target || ev.srcElement);
        const html = currentDocument.documentElement;
        const body = currentDocument.body;
        return new axis_values_1.default(Math.round(curCoordObject.clientX + (html && html.scrollLeft || body && body.scrollLeft || 0) -
            (html.clientLeft || 0)), Math.round(curCoordObject.clientY + (html && html.scrollTop || body && body.scrollTop || 0) -
            (html.clientTop || 0)));
    }
    return new axis_values_1.default(Math.round(curCoordObject.pageX), Math.round(curCoordObject.pageY));
}
exports.getEventPageCoordinates = getEventPageCoordinates;
function getIframePointRelativeToParentFrame(pos, iframeWin) {
    const iframe = domUtils.findIframeByWindow(iframeWin);
    const iframeOffset = (0, exports.getOffsetPosition)(iframe);
    const iframeBorders = styleUtils.getBordersWidth(iframe);
    const iframePadding = styleUtils.getElementPadding(iframe);
    return (0, exports.offsetToClientCoords)({
        x: pos.x + iframeOffset.left + iframeBorders.left + iframePadding.left,
        y: pos.y + iframeOffset.top + iframeBorders.top + iframePadding.top,
    });
}
exports.getIframePointRelativeToParentFrame = getIframePointRelativeToParentFrame;
function findCenter(el) {
    const rectangle = (0, exports.getElementRectangle)(el);
    return new axis_values_1.default(Math.round(rectangle.left + rectangle.width / 2), Math.round(rectangle.top + rectangle.height / 2));
}
exports.findCenter = findCenter;
function getClientPosition(el) {
    const { left, top } = (0, exports.getOffsetPosition)(el);
    const clientCoords = (0, exports.offsetToClientCoords)({ x: left, y: top });
    clientCoords.x = Math.round(clientCoords.x);
    clientCoords.y = Math.round(clientCoords.y);
    return clientCoords;
}
exports.getClientPosition = getClientPosition;
function isInRectangle({ x, y }, rectangle) {
    return x >= rectangle.left && x <= rectangle.right && y >= rectangle.top && y <= rectangle.bottom;
}
exports.isInRectangle = isInRectangle;
function getWindowPosition() {
    const x = window.screenLeft || window.screenX;
    const y = window.screenTop || window.screenY;
    return new axis_values_1.default(x, y);
}
exports.getWindowPosition = getWindowPosition;
function isIframeVisible(el) {
    return !hiddenUsingStyles(el);
}
exports.isIframeVisible = isIframeVisible;
function hiddenUsingStyles(el) {
    return styleUtils.get(el, 'visibility') === 'hidden' ||
        styleUtils.get(el, 'display') === 'none';
}
function hiddenByRectangle(el) {
    const elementRectangle = (0, exports.getElementRectangle)(el);
    return elementRectangle.width === 0 ||
        elementRectangle.height === 0;
}
function isElementVisible(el) {
    if (domUtils.isTextNode(el))
        return !styleUtils.isNotVisibleNode(el);
    if (!domUtils.isContentEditableElement(el) &&
        !domUtils.isSVGElement(el) &&
        hiddenByRectangle(el))
        return false;
    if (domUtils.isMapElement(el)) {
        const mapContainer = domUtils.getMapContainer(domUtils.closest(el, 'map'));
        return mapContainer ? isElementVisible(mapContainer) : false;
    }
    if (styleUtils.isSelectVisibleChild(el)) {
        const select = domUtils.getSelectParent(el);
        const childRealIndex = domUtils.getChildVisibleIndex(select, el);
        const realSelectSizeValue = styleUtils.getSelectElementSize(select);
        const topVisibleIndex = Math.max(styleUtils.getScrollTop(select) / styleUtils.getOptionHeight(select), 0);
        const bottomVisibleIndex = topVisibleIndex + realSelectSizeValue - 1;
        const optionVisibleIndex = Math.max(childRealIndex - topVisibleIndex, 0);
        return optionVisibleIndex >= topVisibleIndex && optionVisibleIndex <= bottomVisibleIndex;
    }
    if (domUtils.isSVGElement(el)) {
        const hiddenParent = domUtils.findParent(el, true, (parent) => {
            return hiddenUsingStyles(parent);
        });
        if (!hiddenParent)
            return !hiddenByRectangle(el);
        return false;
    }
    return styleUtils.hasDimensions(el) && !hiddenUsingStyles(el);
}
exports.isElementVisible = isElementVisible;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9zaXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L2NvcmUvdXRpbHMvcG9zaXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxvRUFBNEM7QUFDNUMsb0RBQXNDO0FBQ3RDLGdEQUFrQztBQUNsQyx1RUFBa0U7QUFDbEUsK0VBQThFO0FBQzlFLHFFQUE2QztBQUdoQyxRQUFBLG1CQUFtQixHQUFJLG9CQUFVLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQztBQUNyRSxRQUFBLGlCQUFpQixHQUFNLG9CQUFVLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQztBQUNuRSxRQUFBLG9CQUFvQixHQUFHLG9CQUFVLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQztBQUVuRixTQUFnQixtQkFBbUIsQ0FBRSxNQUFtQjtJQUNwRCxNQUFNLGFBQWEsR0FBTyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3pELE1BQU0sSUFBSSxHQUFnQixhQUFhLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3hGLE1BQU0sV0FBVyxHQUFTLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0lBQ3pELE1BQU0sU0FBUyxHQUFXLHlCQUFjLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNwRixNQUFNLFFBQVEsR0FBWSxVQUFVLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDOUQsTUFBTSxpQkFBaUIsR0FBRyxRQUFRLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDN0QsTUFBTSxZQUFZ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LFVBQVUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLENBQUMsTUFBWSxFQUFFLEVBQUU7WUFDaEUsT0FBTyxpQkFBaUIsQ0FBQyxNQUFnQyxDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsWUFBWTtZQUNiLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxFQUE0QixDQUFDLENBQUM7UUFFNUQsT0FBTyxLQUFLLENBQUM7S0FDaEI7SUFFRCxPQUFPLFVBQVUsQ0FBQyxhQUFhLENBQUMsRUFBaUIsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBNEIsQ0FBQyxDQUFDO0FBQzNHLENBQUM7QUF0Q0QsNENBc0NDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGhhbW1lcmhlYWQgZnJvbSAnLi4vZGVwcy9oYW1tZXJoZWFkJztcbmltcG9ydCAqIGFzIHN0eWxlVXRpbHMgZnJvbSAnLi9zdHlsZSc7XG5pbXBvcnQgKiBhcyBkb21VdGlscyBmcm9tICcuL2RvbSc7XG5pbXBvcnQgQXhpc1ZhbHVlcywgeyBBeGlzVmFsdWVzRGF0YSB9IGZyb20gJy4vdmFsdWVzL2F4aXMtdmFsdWVzJztcbmltcG9ydCBCb3VuZGFyeVZhbHVlcywgeyBCb3VuZGFyeVZhbHVlc0RhdGEgfSBmcm9tICcuL3ZhbHVlcy9ib3VuZGFyeS12YWx1ZXMnO1xuaW1wb3J0IERpbWVuc2lvbnMgZnJvbSAnLi92YWx1ZXMvZGltZW5zaW9ucyc7XG5cblxuZXhwb3J0IGNvbnN0IGdldEVsZW1lbnRSZWN0YW5nbGUgID0gaGFtbWVyaGVhZC51dGlscy5wb3NpdGlvbi5nZXRFbGVtZW50UmVjdGFuZ2xlO1xuZXhwb3J0IGNvbnN0IGdldE9mZnNldFBvc2l0aW9uICAgID0gaGFtbWVyaGVhZC51dGlscy5wb3NpdGlvbi5nZXRPZmZzZXRQb3NpdGlvbjtcbmV4cG9ydCBjb25zdCBvZmZzZXRUb0NsaWVudENvb3JkcyA9IGhhbW1lcmhlYWQudXRpbHMucG9zaXRpb24ub2Zmc2V0VG9DbGllbnRDb29yZHM7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDbGllbnREaW1lbnNpb25zICh0YXJnZXQ6IEhUTUxFbGVtZW50KTogRGltZW5zaW9ucyB7XG4gICAgY29uc3QgaXNIdG1sRWxlbWVudCAgICAgPSBkb21VdGlscy5pc0h0bWxFbGVtZW50KHRhcmdldCk7XG4gICAgY29uc3QgYm9keSAgICAgICAgICAgICAgPSBpc0h0bWxFbGVtZW50ID8gdGFyZ2V0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF0gOiBudWxsO1xuICAgIGNvbnN0IGVsZW1lbnRSZWN0ICAgICAgID0gdGFyZ2V0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGNvbnN0IGVsQm9yZGVycyAgICAgICAgID0gQm91bmRhcnlWYWx1ZXMuY3JlYXRlKHN0eWxlVXRpbHMuZ2V0Qm9yZGVyc1dpZHRoKHRhcmdldCkpO1xuICAgIGNvbnN0IGVsU2Nyb2xsICAgICAgICAgID0gc3R5bGVVdGlscy5nZXRFbGVtZW50U2Nyb2xsKHRhcmdldCk7XG4gICAgY29uc3QgaXNFbGVtZW50SW5JZnJhbWUgPSBkb21VdGlscy5pc0VsZW1lbnRJbklmcmFtZSh0YXJnZXQpO1xuICAgIGNvbnN0IGlzQ29tcGF0TW9kZSAgICAgID0gdGFyZ2V0Lm93bmVyRG9jdW1lbnQuY29tcGF0TW9kZSA9PT0gJ0JhY2tDb21wYXQnO1xuICAgIGNvbnN0IGVsUG9zaXRpb24gICAgICAgID0gaXNIdG1sRWxlbWVudCA/IG5ldyBBeGlzVmFsdWVzKDAsIDApIDogQXhpc1ZhbHVlcy5jcmVhdGUoZWxlbWVudFJlY3QpO1xuXG4gICAgbGV0IGVsSGVpZ2h0ICAgPSBlbGVtZW50UmVjdC5oZWlnaHQ7XG4gICAgbGV0IGVsV2lkdGggICAgPSBlbGVtZW50UmVjdC53aWR0aDtcblxuICAgIGlmIChpc0h0bWxFbGVtZW50KSB7XG4gICAgICAgIGlmIChib2R5ICYmIGlzQ29tcGF0TW9kZSkge1xuICAgICAgICAgICAgZWxIZWlnaHQgPSBib2R5LmNsaWVudEhlaWdodDtcbiAgICAgICAgICAgIGVsV2lkdGggID0gYm9keS5jbGllbnRXaWR0aDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGVsSGVpZ2h0ID0gdGFyZ2V0LmNsaWVudEhlaWdodDtcbiAgICAgICAgICAgIGVsV2lkdGggID0gdGFyZ2V0LmNsaWVudFdpZHRoO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGlzRWxlbWVudEluSWZyYW1lKSB7XG4gICAgICAgIGNvbnN0IGlmcmFtZUVsZW1lbnQgPSBkb21VdGlscy5nZXRJZnJhbWVCeUVsZW1lbnQodGFyZ2V0KTtcblxuICAgICAgICBpZiAoaWZyYW1lRWxlbWVudCkge1xuICAgICAgICAgICAgY29uc3QgaWZyYW1lT2Zmc2V0ICA9IGdldE9mZnNldFBvc2l0aW9uKGlmcmFtZUVsZW1lbnQpO1xuICAgICAgICAgICAgY29uc3QgY2xpZW50T2Zmc2V0ICA9IG9mZnNldFRvQ2xpZW50Q29vcmRzKEF4aXNWYWx1ZXMuY3JlYXRlKGlmcmFtZU9mZnNldCkpO1xuICAgICAgICAgICAgY29uc3QgaWZyYW1lQm9yZGVycyA9IHN0eWxlVXRpbHMuZ2V0Qm9yZGVyc1dpZHRoKGlmcmFtZUVsZW1lbnQpO1xuXG4gICAgICAgICAgICBlbFBvc2l0aW9uLmFkZChjbGllbnRPZmZzZXQpLmFkZChBeGlzVmFsdWVzLmNyZWF0ZShpZnJhbWVCb3JkZXJzKSk7XG5cbiAgICAgICAgICAgIGlmIChpc0h0bWxFbGVtZW50KVxuICAgICAgICAgICAgICAgIGVsQm9yZGVycy5hZGQoaWZyYW1lQm9yZGVycyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBoYXNSaWdodFNjcm9sbGJhciAgPSAhaXNIdG1sRWxlbWVudCAmJiBzdHlsZVV0aWxzLmdldElubmVyV2lkdGgodGFyZ2V0KSAhPT0gdGFyZ2V0LmNsaWVudFdpZHRoO1xuICAgIGNvbnN0IGhhc0JvdHRvbVNjcm9sbGJhciA9ICFpc0h0bWxFbGVtZW50ICYmIHN0eWxlVXRpbHMuZ2V0SW5uZXJIZWlnaHQodGFyZ2V0KSAhPT0gdGFyZ2V0LmNsaWVudEhlaWdodDtcblxuICAgIGNvbnN0IHNjcm9sbGJhciA9IHtcbiAgICAgICAgcmlnaHQ6ICBoYXNSaWdodFNjcm9sbGJhciA/IGRvbVV0aWxzLmdldFNjcm9sbGJhclNpemUoKSA6IDAsXG4gICAgICAgIGJvdHRvbTogaGFzQm90dG9tU2Nyb2xsYmFyID8gZG9tVXRpbHMuZ2V0U2Nyb2xsYmFyU2l6ZSgpIDogMCxcbiAgICB9O1xuXG4gICAgcmV0dXJuIG5ldyBEaW1lbnNpb25zKGVsV2lkdGgsIGVsSGVpZ2h0LCBlbFBvc2l0aW9uLCBlbEJvcmRlcnMsIGVsU2Nyb2xsLCBzY3JvbGxiYXIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RWxlbWVudEZyb21Qb2ludCAoeyB4LCB5IH06IEF4aXNWYWx1ZXNEYXRhPG51bWJlcj4pOiBFbGVtZW50IHwgbnVsbCB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IGllRm4gPSBkb2N1bWVudC5nZXRFbGVtZW50RnJvbVBvaW50O1xuICAgIGNvbnN0IGZ1bmMgPSBpZUZuIHx8IGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQ7XG5cbiAgICBsZXQgZWw6IEVsZW1lbnQgfCBudWxsID0gbnVsbDtcblxuICAgIHRyeSB7XG4gICAgICAgIC8vIFBlcm1pc3Npb24gZGVuaWVkIHRvIGFjY2VzcyBwcm9wZXJ0eSAnZ2V0RWxlbWVudEZyb21Qb2ludCcgZXJyb3IgaW4gaWZyYW1lXG4gICAgICAgIGVsID0gZnVuYy5jYWxsKGRvY3VtZW50LCB4LCB5KTtcbiAgICB9XG4gICAgY2F0Y2gge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvL05PVEU6IGVsZW1lbnRGcm9tUG9pbnQgcmV0dXJucyBudWxsIHdoZW4gaXMncyBhIGJvcmRlciBvZiBhbiBpZnJhbWVcbiAgICBpZiAoZWwgPT09IG51bGwpXG4gICAgICAgIGVsID0gZnVuYy5jYWxsKGRvY3VtZW50LCB4IC0gMSwgeSAtIDEpO1xuXG4gICAgd2hpbGUgKGVsICYmIGVsLnNoYWRvd1Jvb3QgJiYgZWwuc2hhZG93Um9vdC5lbGVtZW50RnJvbVBvaW50KSB7XG4gICAgICAgIGNvbnN0IHNoYWRvd0VsID0gZWwuc2hhZG93Um9vdC5lbGVtZW50RnJvbVBvaW50KHgsIHkpO1xuXG4gICAgICAgIGlmICghc2hhZG93RWwgfHwgZWwgPT09IHNoYWRvd0VsKVxuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgZWwgPSBzaGFkb3dFbDtcbiAgICB9XG5cbiAgICByZXR1cm4gZWw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjUmVsYXRpdmVQb3NpdGlvbiAoZGltZW5zaW9uczogRGltZW5zaW9ucywgdG9EaW1lbnNpb25zOiBEaW1lbnNpb25zKTogQm91bmRhcnlWYWx1ZXNEYXRhIHtcbiAgICBjb25zdCBwb3MgPSBCb3VuZGFyeVZhbHVlcy5jcmVhdGUoe1xuICAgICAgICB0b3A6ICAgIGRpbWVuc2lvbnMudG9wIC0gdG9EaW1lbnNpb25zLnRvcCxcbiAgICAgICAgbGVmdDogICBkaW1lbnNpb25zLmxlZnQgLSB0b0RpbWVuc2lvbnMubGVmdCxcbiAgICAgICAgcmlnaHQ6ICB0b0RpbWVuc2lvbnMucmlnaHQgLSBkaW1lbnNpb25zLnJpZ2h0LFxuICAgICAgICBib3R0b206IHRvRGltZW5zaW9ucy5ib3R0b20gLSBkaW1lbnNpb25zLmJvdHRvbSxcbiAgICB9KTtcblxuICAgIHJldHVybiBwb3Muc3ViKHRvRGltZW5zaW9ucy5ib3JkZXIpLnN1Yih0b0RpbWVuc2lvbnMuc2Nyb2xsYmFyKS5yb3VuZChNYXRoLmNlaWwsIE1hdGguZmxvb3IpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0SWZyYW1lQ2xpZW50Q29vcmRpbmF0ZXMgKGlmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQpOiBCb3VuZGFyeVZhbHVlcyB7XG4gICAgY29uc3QgeyBsZWZ0LCB0b3AgfSAgICAgICA9IGdldE9mZnNldFBvc2l0aW9uKGlmcmFtZSk7XG4gICAgY29uc3QgY2xpZW50UG9zaXRpb24gICAgICA9IG9mZnNldFRvQ2xpZW50Q29vcmRzKHsgeDogbGVmdCwgeTogdG9wIH0pO1xuICAgIGNvbnN0IGlmcmFtZUJvcmRlcnMgICAgICAgPSBzdHlsZVV0aWxzLmdldEJvcmRlcnNXaWR0aChpZnJhbWUpO1xuICAgIGNvbnN0IGlmcmFtZVBhZGRpbmcgICAgICAgPSBzdHlsZVV0aWxzLmdldEVsZW1lbnRQYWRkaW5nKGlmcmFtZSk7XG4gICAgY29uc3QgaWZyYW1lUmVjdGFuZ2xlTGVmdCA9IGNsaWVudFBvc2l0aW9uLnggKyBpZnJhbWVCb3JkZXJzLmxlZnQgKyBpZnJhbWVQYWRkaW5nLmxlZnQ7XG4gICAgY29uc3QgaWZyYW1lUmVjdGFuZ2xlVG9wICA9IGNsaWVudFBvc2l0aW9uLnkgKyBpZnJhbWVCb3JkZXJzLnRvcCArIGlmcmFtZVBhZGRpbmcudG9wO1xuXG4gICAgcmV0dXJuIG5ldyBCb3VuZGFyeVZhbHVlcyhpZnJhbWVSZWN0YW5nbGVUb3AsXG4gICAgICAgIGlmcmFtZVJlY3RhbmdsZUxlZnQgKyBzdHlsZVV0aWxzLmdldFdpZHRoKGlmcmFtZSksXG4gICAgICAgIGlmcmFtZVJlY3RhbmdsZVRvcCArIHN0eWxlVXRpbHMuZ2V0SGVpZ2h0KGlmcmFtZSksXG4gICAgICAgIGlmcmFtZVJlY3RhbmdsZUxlZnQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29udGFpbnNPZmZzZXQgKGVsOiBIVE1MRWxlbWVudCwgb2Zmc2V0WD86IG51bWJlciwgb2Zmc2V0WT86IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBnZXRDbGllbnREaW1lbnNpb25zKGVsKTtcbiAgICBjb25zdCB3aWR0aCAgICAgID0gTWF0aC5tYXgoZWwuc2Nyb2xsV2lkdGgsIGRpbWVuc2lvbnMud2lkdGgpO1xuICAgIGNvbnN0IGhlaWdodCAgICAgPSBNYXRoLm1heChlbC5zY3JvbGxIZWlnaHQsIGRpbWVuc2lvbnMuaGVpZ2h0KTtcbiAgICBjb25zdCBtYXhYICAgICAgID0gZGltZW5zaW9ucy5zY3JvbGxiYXIucmlnaHQgKyBkaW1lbnNpb25zLmJvcmRlci5sZWZ0ICsgZGltZW5zaW9ucy5ib3JkZXIucmlnaHQgKyB3aWR0aDtcbiAgICBjb25zdCBtYXhZICAgICAgID0gZGltZW5zaW9ucy5zY3JvbGxiYXIuYm90dG9tICsgZGltZW5zaW9ucy5ib3JkZXIudG9wICsgZGltZW5zaW9ucy5ib3JkZXIuYm90dG9tICsgaGVpZ2h0O1xuXG4gICAgcmV0dXJuICh0eXBlb2Ygb2Zmc2V0WCA9PT0gJ3VuZGVmaW5lZCcgfHwgb2Zmc2V0WCA+PSAwICYmIG1heFggPj0gb2Zmc2V0WCkgJiZcbiAgICAgICAgICAgKHR5cGVvZiBvZmZzZXRZID09PSAndW5kZWZpbmVkJyB8fCBvZmZzZXRZID49IDAgJiYgbWF4WSA+PSBvZmZzZXRZKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEV2ZW50QWJzb2x1dGVDb29yZGluYXRlcyAoZXY6IE1vdXNlRXZlbnQpOiBBeGlzVmFsdWVzPG51bWJlcj4ge1xuICAgIGNvbnN0IGVsICAgICAgICAgICAgICA9IGV2LnRhcmdldCB8fCBldi5zcmNFbGVtZW50O1xuICAgIGNvbnN0IHBhZ2VDb29yZGluYXRlcyA9IGdldEV2ZW50UGFnZUNvb3JkaW5hdGVzKGV2KTtcbiAgICBjb25zdCBjdXJEb2N1bWVudCAgICAgPSBkb21VdGlscy5maW5kRG9jdW1lbnQoZWwpO1xuICAgIGxldCB4T2Zmc2V0ICAgICAgICAgPSAwO1xuICAgIGxldCB5T2Zmc2V0ICAgICAgICAgPSAwO1xuXG4gICAgaWYgKGRvbVV0aWxzLmlzRWxlbWVudEluSWZyYW1lKGN1ckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkpIHtcbiAgICAgICAgY29uc3QgY3VycmVudElmcmFtZSA9IGRvbVV0aWxzLmdldElmcmFtZUJ5RWxlbWVudChjdXJEb2N1bWVudCk7XG5cbiAgICAgICAgaWYgKGN1cnJlbnRJZnJhbWUpIHtcbiAgICAgICAgICAgIGNvbnN0IGlmcmFtZU9mZnNldCAgPSBnZXRPZmZzZXRQb3NpdGlvbihjdXJyZW50SWZyYW1lKTtcbiAgICAgICAgICAgIGNvbnN0IGlmcmFtZUJvcmRlcnMgPSBzdHlsZVV0aWxzLmdldEJvcmRlcnNXaWR0aChjdXJyZW50SWZyYW1lKTtcblxuICAgICAgICAgICAgeE9mZnNldCA9IGlmcmFtZU9mZnNldC5sZWZ0ICsgaWZyYW1lQm9yZGVycy5sZWZ0O1xuICAgICAgICAgICAgeU9mZnNldCA9IGlmcmFtZU9mZnNldC50b3AgKyBpZnJhbWVCb3JkZXJzLnRvcDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXcgQXhpc1ZhbHVlcyhwYWdlQ29vcmRpbmF0ZXMueCArIHhPZmZzZXQsIHBhZ2VDb29yZGluYXRlcy55ICsgeU9mZnNldCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRFdmVudFBhZ2VDb29yZGluYXRlcyAoZXY6IE1vdXNlRXZlbnQpOiBBeGlzVmFsdWVzPG51bWJlcj4ge1xuICAgIGNvbnN0IGN1ckNvb3JkT2JqZWN0ID0gL150b3VjaC8udGVzdChldi50eXBlKSAmJiAoZXYgYXMgdW5rbm93biBhcyBUb3VjaEV2ZW50KS50YXJnZXRUb3VjaGVzID8gKGV2IGFzIHVua25vd24gYXMgVG91Y2hFdmVudCkudGFyZ2V0VG91Y2hlc1swXSB8fCAoZXYgYXMgdW5rbm93biBhcyBUb3VjaEV2ZW50KS5jaGFuZ2VkVG91Y2hlc1swXSA6IGV2O1xuXG4gICAgY29uc3QgYm90aFBhZ2VDb29yZGluYXRlc0FyZVplcm8gICAgICA9IGN1ckNvb3JkT2JqZWN0LnBhZ2VYID09PSAwICYmIGN1ckNvb3JkT2JqZWN0LnBhZ2VZID09PSAwO1xuICAgIGNvbnN0IG5vdEJvdGhDbGllbnRDb29yZGluYXRlc0FyZVplcm8gPSBjdXJDb29yZE9iamVjdC5jbGllbnRYICE9PSAwIHx8IGN1ckNvb3JkT2JqZWN0LmNsaWVudFkgIT09IDA7XG5cbiAgICBpZiAoKGN1ckNvb3JkT2JqZWN0LnBhZ2VYID09PSBudWxsIHx8IGJvdGhQYWdlQ29vcmRpbmF0ZXNBcmVaZXJvICYmIG5vdEJvdGhDbGllbnRDb29yZGluYXRlc0FyZVplcm8pICYmXG4gICAgICAgIGN1ckNvb3JkT2JqZWN0LmNsaWVudFggIT09IG51bGwpIHtcbiAgICAgICAgY29uc3QgY3VycmVudERvY3VtZW50ID0gZG9tVXRpbHMuZmluZERvY3VtZW50KGV2LnRhcmdldCB8fCBldi5zcmNFbGVtZW50KTtcbiAgICAgICAgY29uc3QgaHRtbCAgICAgICAgICAgID0gY3VycmVudERvY3VtZW50LmRvY3VtZW50RWxlbWVudDtcbiAgICAgICAgY29uc3QgYm9keSAgICAgICAgICAgID0gY3VycmVudERvY3VtZW50LmJvZHk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBBeGlzVmFsdWVzPG51bWJlcj4oXG4gICAgICAgICAgICBNYXRoLnJvdW5kKGN1ckNvb3JkT2JqZWN0LmNsaWVudFggKyAoaHRtbCAmJiBodG1sLnNjcm9sbExlZnQgfHwgYm9keSAmJiBib2R5LnNjcm9sbExlZnQgfHwgMCkgLVxuICAgICAgICAgICAgICAgIChodG1sLmNsaWVudExlZnQgfHwgMCkpLFxuICAgICAgICAgICAgTWF0aC5yb3VuZChjdXJDb29yZE9iamVjdC5jbGllbnRZICsgKGh0bWwgJiYgaHRtbC5zY3JvbGxUb3AgfHwgYm9keSAmJiBib2R5LnNjcm9sbFRvcCB8fCAwKSAtXG4gICAgICAgICAgICAgICAgKGh0bWwuY2xpZW50VG9wIHx8IDApKVxuICAgICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IEF4aXNWYWx1ZXM8bnVtYmVyPihcbiAgICAgICAgTWF0aC5yb3VuZChjdXJDb29yZE9iamVjdC5wYWdlWCksXG4gICAgICAgIE1hdGgucm91bmQoY3VyQ29vcmRPYmplY3QucGFnZVkpXG4gICAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldElmcmFtZVBvaW50UmVsYXRpdmVUb1BhcmVudEZyYW1lIChwb3M6IEF4aXNWYWx1ZXM8bnVtYmVyPiwgaWZyYW1lV2luOiBXaW5kb3cpOiBBeGlzVmFsdWVzPG51bWJlcj4ge1xuICAgIGNvbnN0IGlmcmFtZSAgICAgICAgPSBkb21VdGlscy5maW5kSWZyYW1lQnlXaW5kb3coaWZyYW1lV2luKTtcbiAgICBjb25zdCBpZnJhbWVPZmZzZXQgID0gZ2V0T2Zmc2V0UG9zaXRpb24oaWZyYW1lKTtcbiAgICBjb25zdCBpZnJhbWVCb3JkZXJzID0gc3R5bGVVdGlscy5nZXRCb3JkZXJzV2lkdGgoaWZyYW1lKTtcbiAgICBjb25zdCBpZnJhbWVQYWRkaW5nID0gc3R5bGVVdGlscy5nZXRFbGVtZW50UGFkZGluZyhpZnJhbWUpO1xuXG4gICAgcmV0dXJuIG9mZnNldFRvQ2xpZW50Q29vcmRzKHtcbiAgICAgICAgeDogcG9zLnggKyBpZnJhbWVPZmZzZXQubGVmdCArIGlmcmFtZUJvcmRlcnMubGVmdCArIGlmcmFtZVBhZGRpbmcubGVmdCxcbiAgICAgICAgeTogcG9zLnkgKyBpZnJhbWVPZmZzZXQudG9wICsgaWZyYW1lQm9yZGVycy50b3AgKyBpZnJhbWVQYWRkaW5nLnRvcCxcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRDZW50ZXIgKGVsOiBIVE1MRWxlbWVudCk6IEF4aXNWYWx1ZXM8bnVtYmVyPiB7XG4gICAgY29uc3QgcmVjdGFuZ2xlID0gZ2V0RWxlbWVudFJlY3RhbmdsZShlbCk7XG5cbiAgICByZXR1cm4gbmV3IEF4aXNWYWx1ZXM8bnVtYmVyPihcbiAgICAgICAgTWF0aC5yb3VuZChyZWN0YW5nbGUubGVmdCArIHJlY3RhbmdsZS53aWR0aCAvIDIpLFxuICAgICAgICBNYXRoLnJvdW5kKHJlY3RhbmdsZS50b3AgKyByZWN0YW5nbGUuaGVpZ2h0IC8gMiksXG4gICAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENsaWVudFBvc2l0aW9uIChlbDogSFRNTEVsZW1lbnQpOiBhbnkge1xuICAgIGNvbnN0IHsgbGVmdCwgdG9wIH0gPSBnZXRPZmZzZXRQb3NpdGlvbihlbCk7XG5cbiAgICBjb25zdCBjbGllbnRDb29yZHMgPSBvZmZzZXRUb0NsaWVudENvb3Jkcyh7IHg6IGxlZnQsIHk6IHRvcCB9KTtcblxuICAgIGNsaWVudENvb3Jkcy54ID0gTWF0aC5yb3VuZChjbGllbnRDb29yZHMueCk7XG4gICAgY2xpZW50Q29vcmRzLnkgPSBNYXRoLnJvdW5kKGNsaWVudENvb3Jkcy55KTtcblxuICAgIHJldHVybiBjbGllbnRDb29yZHM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0luUmVjdGFuZ2xlICh7IHgsIHkgfTogQXhpc1ZhbHVlczxudW1iZXI+LCByZWN0YW5nbGU6IEJvdW5kYXJ5VmFsdWVzKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHggPj0gcmVjdGFuZ2xlLmxlZnQgJiYgeCA8PSByZWN0YW5nbGUucmlnaHQgJiYgeSA+PSByZWN0YW5nbGUudG9wICYmIHkgPD0gcmVjdGFuZ2xlLmJvdHRvbTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFdpbmRvd1Bvc2l0aW9uICgpOiBBeGlzVmFsdWVzPG51bWJlcj4ge1xuICAgIGNvbnN0IHggPSB3aW5kb3cuc2NyZWVuTGVmdCB8fCB3aW5kb3cuc2NyZWVuWDtcbiAgICBjb25zdCB5ID0gd2luZG93LnNjcmVlblRvcCB8fCB3aW5kb3cuc2NyZWVuWTtcblxuICAgIHJldHVybiBuZXcgQXhpc1ZhbHVlcyh4LCB5KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzSWZyYW1lVmlzaWJsZSAoZWw6IE5vZGUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIWhpZGRlblVzaW5nU3R5bGVzKGVsIGFzIEhUTUxFbGVtZW50KTtcbn1cblxuZnVuY3Rpb24gaGlkZGVuVXNpbmdTdHlsZXMgKGVsOiBIVE1MRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzdHlsZVV0aWxzLmdldChlbCwgJ3Zpc2liaWxpdHknKSA9PT0gJ2hpZGRlbicgfHxcbiAgICAgICAgc3R5bGVVdGlscy5nZXQoZWwsICdkaXNwbGF5JykgPT09ICdub25lJztcbn1cblxuZnVuY3Rpb24gaGlkZGVuQnlSZWN0YW5nbGUgKGVsOiBIVE1MRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGVsZW1lbnRSZWN0YW5nbGUgPSBnZXRFbGVtZW50UmVjdGFuZ2xlKGVsKTtcblxuICAgIHJldHVybiBlbGVtZW50UmVjdGFuZ2xlLndpZHRoID09PSAwIHx8XG4gICAgICAgIGVsZW1lbnRSZWN0YW5nbGUuaGVpZ2h0ID09PSAwO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNFbGVtZW50VmlzaWJsZSAoZWw6IE5vZGUpOiBib29sZWFuIHtcbiAgICBpZiAoZG9tVXRpbHMuaXNUZXh0Tm9kZShlbCkpXG4gICAgICAgIHJldHVybiAhc3R5bGVVdGlscy5pc05vdFZpc2libGVOb2RlKGVsKTtcblxuICAgIGlmICghZG9tVXRpbHMuaXNDb250ZW50RWRpdGFibGVFbGVtZW50KGVsKSAmJlxuICAgICAgICAhZG9tVXRpbHMuaXNTVkdFbGVtZW50KGVsKSAmJlxuICAgICAgICBoaWRkZW5CeVJlY3RhbmdsZShlbCBhcyBIVE1MRWxlbWVudCkpXG4gICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgIGlmIChkb21VdGlscy5pc01hcEVsZW1lbnQoZWwpKSB7XG4gICAgICAgIGNvbnN0IG1hcENvbnRhaW5lciA9IGRvbVV0aWxzLmdldE1hcENvbnRhaW5lcihkb21VdGlscy5jbG9zZXN0KGVsLCAnbWFwJykpO1xuXG4gICAgICAgIHJldHVybiBtYXBDb250YWluZXIgPyBpc0VsZW1lbnRWaXNpYmxlKG1hcENvbnRhaW5lcikgOiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoc3R5bGVVdGlscy5pc1NlbGVjdFZpc2libGVDaGlsZChlbCkpIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ICAgICAgICAgICAgICA9IGRvbVV0aWxzLmdldFNlbGVjdFBhcmVudChlbCkgYXMgSFRNTFNlbGVjdEVsZW1lbnQ7XG4gICAgICAgIGNvbnN0IGNoaWxkUmVhbEluZGV4ICAgICAgPSBkb21VdGlscy5nZXRDaGlsZFZpc2libGVJbmRleChzZWxlY3QsIGVsKTtcbiAgICAgICAgY29uc3QgcmVhbFNlbGVjdFNpemVWYWx1ZSA9IHN0eWxlVXRpbHMuZ2V0U2VsZWN0RWxlbWVudFNpemUoc2VsZWN0KTtcbiAgICAgICAgY29uc3QgdG9wVmlzaWJsZUluZGV4ICAgICA9IE1hdGgubWF4KHN0eWxlVXRpbHMuZ2V0U2Nyb2xsVG9wKHNlbGVjdCkgLyBzdHlsZVV0aWxzLmdldE9wdGlvbkhlaWdodChzZWxlY3QpLCAwKTtcbiAgICAgICAgY29uc3QgYm90dG9tVmlzaWJsZUluZGV4ICA9IHRvcFZpc2libGVJbmRleCArIHJlYWxTZWxlY3RTaXplVmFsdWUgLSAxO1xuICAgICAgICBjb25zdCBvcHRpb25WaXNpYmxlSW5kZXggID0gTWF0aC5tYXgoY2hpbGRSZWFsSW5kZXggLSB0b3BWaXNpYmxlSW5kZXgsIDApO1xuXG4gICAgICAgIHJldHVybiBvcHRpb25WaXNpYmxlSW5kZXggPj0gdG9wVmlzaWJsZUluZGV4ICYmIG9wdGlvblZpc2libGVJbmRleCA8PSBib3R0b21WaXNpYmxlSW5kZXg7XG4gICAgfVxuXG4gICAgaWYgKGRvbVV0aWxzLmlzU1ZHRWxlbWVudChlbCkpIHtcbiAgICAgICAgY29uc3QgaGlkZGVuUGFyZW50ID0gZG9tVXRpbHMuZmluZFBhcmVudChlbCwgdHJ1ZSwgKHBhcmVudDogTm9kZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGhpZGRlblVzaW5nU3R5bGVzKHBhcmVudCBhcyB1bmtub3duIGFzIEhUTUxFbGVtZW50KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFoaWRkZW5QYXJlbnQpXG4gICAgICAgICAgICByZXR1cm4gIWhpZGRlbkJ5UmVjdGFuZ2xlKGVsIGFzIHVua25vd24gYXMgSFRNTEVsZW1lbnQpO1xuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3R5bGVVdGlscy5oYXNEaW1lbnNpb25zKGVsIGFzIEhUTUxFbGVtZW50KSAmJiAhaGlkZGVuVXNpbmdTdHlsZXMoZWwgYXMgdW5rbm93biBhcyBIVE1MRWxlbWVudCk7XG59XG5cbiJdfQ==
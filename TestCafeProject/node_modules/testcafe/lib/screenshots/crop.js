"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.cropScreenshot = exports.calculateClipInfo = exports.getClipInfoByCropDimensions = exports.getClipInfoByMarkPosition = exports.calculateMarkPosition = void 0;
const utils_1 = require("./utils");
const limit_number_1 = __importDefault(require("../utils/limit-number"));
const render_template_1 = __importDefault(require("../utils/render-template"));
const promisified_functions_1 = require("../utils/promisified-functions");
const test_run_1 = require("../errors/test-run/");
const constants_1 = require("./constants");
const warning_message_1 = __importDefault(require("../notifications/warning-message"));
const MARK_SEED_ERROR_THRESHOLD = 10;
const WHITE_COLOR_PART = 255;
const BLACK_COLOR_PART = 0;
function markSeedToId(markSeed) {
    let id = 0;
    for (let i = 0; i < constants_1.MARK_LENGTH; i++)
        id = id * 2 + (markSeed[i * constants_1.MARK_BYTES_PER_PIXEL] ? 1 : 0);
    return id;
}
function getCorrectedColorPart(colorPart) {
    const isWhite = colorPart > WHITE_COLOR_PART - MARK_SEED_ERROR_THRESHOLD;
    const isBlack = colorPart < MARK_SEED_ERROR_THRESHOLD;
    if (isBlack)
        return BLACK_COLOR_PART;
    if (isWhite)
        return WHITE_COLOR_PART;
    return colorPart;
}
async function validateClipInfo(clipInfo, path) {
    const clipWidth = clipInfo.clipRight - clipInfo.clipLeft;
    const clipHeight = clipInfo.clipBottom - clipInfo.clipTop;
    if (clipWidth <= 0 || clipHeight <= 0) {
        await (0, promisified_functions_1.deleteFile)(path);
        throw new test_run_1.InvalidElementScreenshotDimensionsError(clipWidth, clipHeight);
    }
}
function calculateMarkPosition(pngImage, markSeed) {
    const mark = Buffer.from(markSeed);
    const filtImg = Buffer.from(pngImage.data);
    for (let i = 0; i < filtImg.length; i++)
        filtImg[i] = getCorrectedColorPart(filtImg[i]);
    const markIndex = filtImg.indexOf(mark);
    if (markIndex < 0)
        return null;
    const endPosition = markIndex / constants_1.MARK_BYTES_PER_PIXEL + constants_1.MARK_LENGTH + constants_1.MARK_RIGHT_MARGIN;
    const x = endPosition % pngImage.width || pngImage.width;
    const y = (endPosition - x) / pngImage.width + 1;
    return { x, y };
}
exports.calculateMarkPosition = calculateMarkPosition;
function getClipInfoByMarkPosition(markPosition, { width, height }) {
    const { x, y } = markPosition;
    const clipRight = x;
    const clipBottom = y;
    const clipLeft = clipRight - width;
    const clipTop = clipBottom - height;
    return {
        clipLeft,
        clipTop,
        clipRight,
        clipBottom,
    };
}
exports.getClipInfoByMarkPosition = getClipInfoByMarkPosition;
function getClipInfoByCropDimensions({ clipRight, clipLeft, clipBottom, clipTop }, cropDimensions) {
    if (cropDimensions) {
        const { right, top, bottom, left } = cropDimensions;
        clipRight = (0, limit_number_1.default)(clipLeft + right, clipLeft, clipRight);
        clipBottom = (0, limit_number_1.default)(clipTop + bottom, clipTop, clipBottom);
        clipLeft = (0, limit_number_1.default)(clipLeft + left, clipLeft, clipRight);
        clipTop = (0, limit_number_1.default)(clipTop + top, clipTop, clipBottom);
    }
    return {
        clipLeft,
        clipTop,
        clipRight,
        clipBottom,
    };
}
exports.getClipInfoByCropDimensions = getClipInfoByCropDimensions;
function calculateClipInfo(pngImage, path, markSeed, clientAreaDimensions, cropDimensions) {
    let clipInfo = {
        clipRight: pngImage.width,
        clipBottom: pngImage.height,
        clipLeft: 0,
        clipTop: 0,
    };
    let markPosition = null;
    if (markSeed && clientAreaDimensions) {
        markPosition = calculateMarkPosition(pngImage, markSeed);
        if (!markPosition)
            throw new Error((0, render_template_1.default)(warning_message_1.default.screenshotMarkNotFound, path, markSeedToId(markSeed)));
        clipInfo = getClipInfoByMarkPosition(markPosition, clientAreaDimensions);
    }
    clipInfo = getClipInfoByCropDimensions(clipInfo, cropDimensions);
    if (markPosition && markPosition.y === clipInfo.clipBottom)
        clipInfo.clipBottom--;
    return clipInfo;
}
exports.calculateClipInfo = calculateClipInfo;
async function cropScreenshot(image, { path, markSeed, clientAreaDimensions, cropDimensions }) {
    if (!markSeed && !cropDimensions)
        return null;
    const clip = calculateClipInfo(image, path, markSeed, clientAreaDimensions, cropDimensions);
    await validateClipInfo(clip, path);
    return (0, utils_1.copyImagePart)(image, clip);
}
exports.cropScreenshot = cropScreenshot;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JlZW5zaG90cy9jcm9wLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG1DQUF3QztBQUN4Qyx5RUFBZ0Q7QUFDaEQsK0VBQXNEO0FBQ3RELDBFQUE0RDtBQUM1RCxrREFBOEU7QUFDOUUsMkNBSXFCO0FBRXJCLHVGQUFnRTtBQUVoRSxNQUFNLHlCQUF5QixHQUFHLEVBQUUsQ0FBQztBQUNyQyxNQUFNLGdCQUFnQixHQUFZLEdBQUcsQ0FBQztBQUN0QyxNQUFNLGdCQUFnQixHQUFZLENBQUMsQ0FBQztBQUVwQyxTQUFTLFlBQVksQ0FBRSxRQUFRO0lBQzNCLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUVYLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyx1QkFBVyxFQUFFLENBQUMsRUFBRTtRQUNoQyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsZ0NBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUUvRCxPQUFPLEVBQUUsQ0FBQztBQUNkLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFFLFNBQVM7SUFDckMsTUFBTSxPQUFPLEdBQUcsU0FBUyxHQUFHLGdCQUFnQixHQUFHLHlCQUF5QixDQUFDO0lBQ3pFLE1BQU0sT0FBTyxHQUFHLFNBQVMsR0FBRyx5QkFBeUIsQ0FBQztJQUV0RCxJQUFJLE9BQU87UUFDUCxPQUFPLGdCQUFnQixDQUFDO0lBRTVCLElBQUksT0FBTztRQUNQLE9BQU8sZ0JBQWdCLENBQUM7SUFFNUIsT0FBTyxTQUFTLENBQUM7QUFDckIsQ0FBQztBQUVELEtBQUssVUFBVSxnQkFBZ0IsQ0FBRSxRQUFRLEVBQUUsSUFBSTtJQUMzQyxNQUFNLFNBQVMsR0FBSSxRQUFRLENBQUMsU0FBUyxHQUFH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aUIsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUU1RixNQUFNLGdCQUFnQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUVuQyxPQUFPLElBQUEscUJBQWEsRUFBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDdEMsQ0FBQztBQVRELHdDQVNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29weUltYWdlUGFydCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IGxpbWl0TnVtYmVyIGZyb20gJy4uL3V0aWxzL2xpbWl0LW51bWJlcic7XG5pbXBvcnQgcmVuZGVyVGVtcGxhdGUgZnJvbSAnLi4vdXRpbHMvcmVuZGVyLXRlbXBsYXRlJztcbmltcG9ydCB7IGRlbGV0ZUZpbGUgfSBmcm9tICcuLi91dGlscy9wcm9taXNpZmllZC1mdW5jdGlvbnMnO1xuaW1wb3J0IHsgSW52YWxpZEVsZW1lbnRTY3JlZW5zaG90RGltZW5zaW9uc0Vycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3Rlc3QtcnVuLyc7XG5pbXBvcnQge1xuICAgIE1BUktfTEVOR1RILFxuICAgIE1BUktfUklHSFRfTUFSR0lOLFxuICAgIE1BUktfQllURVNfUEVSX1BJWEVMLFxufSBmcm9tICcuL2NvbnN0YW50cyc7XG5cbmltcG9ydCBXQVJOSU5HX01FU1NBR0VTIGZyb20gJy4uL25vdGlmaWNhdGlvbnMvd2FybmluZy1tZXNzYWdlJztcblxuY29uc3QgTUFSS19TRUVEX0VSUk9SX1RIUkVTSE9MRCA9IDEwO1xuY29uc3QgV0hJVEVfQ09MT1JfUEFSVCAgICAgICAgICA9IDI1NTtcbmNvbnN0IEJMQUNLX0NPTE9SX1BBUlQgICAgICAgICAgPSAwO1xuXG5mdW5jdGlvbiBtYXJrU2VlZFRvSWQgKG1hcmtTZWVkKSB7XG4gICAgbGV0IGlkID0gMDtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTUFSS19MRU5HVEg7IGkrKylcbiAgICAgICAgaWQgPSBpZCAqIDIgKyAobWFya1NlZWRbaSAqIE1BUktfQllURVNfUEVSX1BJWEVMXSA/IDEgOiAwKTtcblxuICAgIHJldHVybiBpZDtcbn1cblxuZnVuY3Rpb24gZ2V0Q29ycmVjdGVkQ29sb3JQYXJ0IChjb2xvclBhcnQpIHtcbiAgICBjb25zdCBpc1doaXRlID0gY29sb3JQYXJ0ID4gV0hJVEVfQ09MT1JfUEFSVCAtIE1BUktfU0VFRF9FUlJPUl9USFJFU0hPTEQ7XG4gICAgY29uc3QgaXNCbGFjayA9IGNvbG9yUGFydCA8IE1BUktfU0VFRF9FUlJPUl9USFJFU0hPTEQ7XG5cbiAgICBpZiAoaXNCbGFjaylcbiAgICAgICAgcmV0dXJuIEJMQUNLX0NPTE9SX1BBUlQ7XG5cbiAgICBpZiAoaXNXaGl0ZSlcbiAgICAgICAgcmV0dXJuIFdISVRFX0NPTE9SX1BBUlQ7XG5cbiAgICByZXR1cm4gY29sb3JQYXJ0O1xufVxuXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZUNsaXBJbmZvIChjbGlwSW5mbywgcGF0aCkge1xuICAgIGNvbnN0IGNsaXBXaWR0aCAgPSBjbGlwSW5mby5jbGlwUmlnaHQgLSBjbGlwSW5mby5jbGlwTGVmdDtcbiAgICBjb25zdCBjbGlwSGVpZ2h0ID0gY2xpcEluZm8uY2xpcEJvdHRvbSAtIGNsaXBJbmZvLmNsaXBUb3A7XG5cbiAgICBpZiAoY2xpcFdpZHRoIDw9IDAgfHwgY2xpcEhlaWdodCA8PSAwKSB7XG4gICAgICAgIGF3YWl0IGRlbGV0ZUZpbGUocGF0aCk7XG5cbiAgICAgICAgdGhyb3cgbmV3IEludmFsaWRFbGVtZW50U2NyZWVuc2hvdERpbWVuc2lvbnNFcnJvcihjbGlwV2lkdGgsIGNsaXBIZWlnaHQpO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZU1hcmtQb3NpdGlvbiAocG5nSW1hZ2UsIG1hcmtTZWVkKSB7XG4gICAgY29uc3QgbWFyayAgICA9IEJ1ZmZlci5mcm9tKG1hcmtTZWVkKTtcbiAgICBjb25zdCBmaWx0SW1nID0gQnVmZmVyLmZyb20ocG5nSW1hZ2UuZGF0YSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbHRJbWcubGVuZ3RoOyBpKyspXG4gICAgICAgIGZpbHRJbWdbaV0gPSBnZXRDb3JyZWN0ZWRDb2xvclBhcnQoZmlsdEltZ1tpXSk7XG5cbiAgICBjb25zdCBtYXJrSW5kZXggPSBmaWx0SW1nLmluZGV4T2YobWFyayk7XG5cbiAgICBpZiAobWFya0luZGV4IDwgMClcbiAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICBjb25zdCBlbmRQb3NpdGlvbiA9IG1hcmtJbmRleCAvIE1BUktfQllURVNfUEVSX1BJWEVMICsgTUFSS19MRU5HVEggKyBNQVJLX1JJR0hUX01BUkdJTjtcblxuICAgIGNvbnN0IHggPSBlbmRQb3NpdGlvbiAlIHBuZ0ltYWdlLndpZHRoIHx8IHBuZ0ltYWdlLndpZHRoO1xuICAgIGNvbnN0IHkgPSAoZW5kUG9zaXRpb24gLSB4KSAvIHBuZ0ltYWdlLndpZHRoICsgMTtcblxuICAgIHJldHVybiB7IHgsIHkgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENsaXBJbmZvQnlNYXJrUG9zaXRpb24gKG1hcmtQb3NpdGlvbiwgeyB3aWR0aCwgaGVpZ2h0IH0pIHtcbiAgICBjb25zdCB7IHgsIHkgfSA9IG1hcmtQb3NpdGlvbjtcblxuICAgIGNvbnN0IGNsaXBSaWdodCAgPSB4O1xuICAgIGNvbnN0IGNsaXBCb3R0b20gPSB5O1xuICAgIGNvbnN0IGNsaXBMZWZ0ICAgPSBjbGlwUmlnaHQgLSB3aWR0aDtcbiAgICBjb25zdCBjbGlwVG9wICAgID0gY2xpcEJvdHRvbSAtIGhlaWdodDtcblxuICAgIHJldHVybiB7XG4gICAgICAgIGNsaXBMZWZ0LFxuICAgICAgICBjbGlwVG9wLFxuICAgICAgICBjbGlwUmlnaHQsXG4gICAgICAgIGNsaXBCb3R0b20sXG4gICAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENsaXBJbmZvQnlDcm9wRGltZW5zaW9ucyAoeyBjbGlwUmlnaHQsIGNsaXBMZWZ0LCBjbGlwQm90dG9tLCBjbGlwVG9wIH0sIGNyb3BEaW1lbnNpb25zKSB7XG4gICAgaWYgKGNyb3BEaW1lbnNpb25zKSB7XG4gICAgICAgIGNvbnN0IHsgcmlnaHQsIHRvcCwgYm90dG9tLCBsZWZ0IH0gPSBjcm9wRGltZW5zaW9ucztcblxuICAgICAgICBjbGlwUmlnaHQgID0gbGltaXROdW1iZXIoY2xpcExlZnQgKyByaWdodCwgY2xpcExlZnQsIGNsaXBSaWdodCk7XG4gICAgICAgIGNsaXBCb3R0b20gPSBsaW1pdE51bWJlcihjbGlwVG9wICsgYm90dG9tLCBjbGlwVG9wLCBjbGlwQm90dG9tKTtcbiAgICAgICAgY2xpcExlZnQgICA9IGxpbWl0TnVtYmVyKGNsaXBMZWZ0ICsgbGVmdCwgY2xpcExlZnQsIGNsaXBSaWdodCk7XG4gICAgICAgIGNsaXBUb3AgICAgPSBsaW1pdE51bWJlcihjbGlwVG9wICsgdG9wLCBjbGlwVG9wLCBjbGlwQm90dG9tKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBjbGlwTGVmdCxcbiAgICAgICAgY2xpcFRvcCxcbiAgICAgICAgY2xpcFJpZ2h0LFxuICAgICAgICBjbGlwQm90dG9tLFxuICAgIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVDbGlwSW5mbyAocG5nSW1hZ2UsIHBhdGgsIG1hcmtTZWVkLCBjbGllbnRBcmVhRGltZW5zaW9ucywgY3JvcERpbWVuc2lvbnMpIHtcbiAgICBsZXQgY2xpcEluZm8gPSB7XG4gICAgICAgIGNsaXBSaWdodDogIHBuZ0ltYWdlLndpZHRoLFxuICAgICAgICBjbGlwQm90dG9tOiBwbmdJbWFnZS5oZWlnaHQsXG4gICAgICAgIGNsaXBMZWZ0OiAgIDAsXG4gICAgICAgIGNsaXBUb3A6ICAgIDAsXG4gICAgfTtcblxuICAgIGxldCBtYXJrUG9zaXRpb24gPSBudWxsO1xuXG4gICAgaWYgKG1hcmtTZWVkICYmIGNsaWVudEFyZWFEaW1lbnNpb25zKSB7XG4gICAgICAgIG1hcmtQb3NpdGlvbiA9IGNhbGN1bGF0ZU1hcmtQb3NpdGlvbihwbmdJbWFnZSwgbWFya1NlZWQpO1xuXG4gICAgICAgIGlmICghbWFya1Bvc2l0aW9uKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlbmRlclRlbXBsYXRlKFdBUk5JTkdfTUVTU0FHRVMuc2NyZWVuc2hvdE1hcmtOb3RGb3VuZCwgcGF0aCwgbWFya1NlZWRUb0lkKG1hcmtTZWVkKSkpO1xuXG4gICAgICAgIGNsaXBJbmZvID0gZ2V0Q2xpcEluZm9CeU1hcmtQb3NpdGlvbihtYXJrUG9zaXRpb24sIGNsaWVudEFyZWFEaW1lbnNpb25zKTtcbiAgICB9XG5cbiAgICBjbGlwSW5mbyA9IGdldENsaXBJbmZvQnlDcm9wRGltZW5zaW9ucyhjbGlwSW5mbywgY3JvcERpbWVuc2lvbnMpO1xuXG4gICAgaWYgKG1hcmtQb3NpdGlvbiAmJiBtYXJrUG9zaXRpb24ueSA9PT0gY2xpcEluZm8uY2xpcEJvdHRvbSlcbiAgICAgICAgY2xpcEluZm8uY2xpcEJvdHRvbS0tO1xuXG4gICAgcmV0dXJuIGNsaXBJbmZvO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JvcFNjcmVlbnNob3QgKGltYWdlLCB7IHBhdGgsIG1hcmtTZWVkLCBjbGllbnRBcmVhRGltZW5zaW9ucywgY3JvcERpbWVuc2lvbnMgfSkge1xuICAgIGlmICghbWFya1NlZWQgJiYgIWNyb3BEaW1lbnNpb25zKVxuICAgICAgICByZXR1cm4gbnVsbDtcblxuICAgIGNvbnN0IGNsaXAgPSBjYWxjdWxhdGVDbGlwSW5mbyhpbWFnZSwgcGF0aCwgbWFya1NlZWQsIGNsaWVudEFyZWFEaW1lbnNpb25zLCBjcm9wRGltZW5zaW9ucyk7XG5cbiAgICBhd2FpdCB2YWxpZGF0ZUNsaXBJbmZvKGNsaXAsIHBhdGgpO1xuXG4gICAgcmV0dXJuIGNvcHlJbWFnZVBhcnQoaW1hZ2UsIGNsaXApO1xufVxuIl19
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const connection_1 = __importDefault(require("../browser/connection"));
const injectables_1 = require("../assets/injectables");
const about_blank_page_markup_1 = __importDefault(require("./about-blank-page-markup"));
const lodash_1 = require("lodash");
const HTTP_STATUS_OK = 200;
const ALL_DOCUMENT_RESPONSES = {
    urlPattern: '*',
    resourceType: 'Document',
    requestStage: 'Response',
};
const CONTENT_SECURITY_POLICY_HEADER_NAMES = [
    'content-security-policy',
    'content-security-policy-report-only',
];
class ResourceInjector {
    constructor(browserId) {
        this._browserId = browserId;
    }
    _getResponseAsString(response) {
        return response.base64Encoded
            ? Buffer.from(response.body, 'base64').toString()
            : response.body;
    }
    _isServicePage(url) {
        const browserConnection = connection_1.default.getById(this._browserId);
        const proxy = browserConnection.browserConnectionGateway.proxy;
        return url.startsWith(proxy.server1Info.domain);
    }
    async _prepareInjectableResources() {
        const browserConnection = connection_1.default.getById(this._browserId);
        const proxy = browserConnection.browserConnectionGateway.proxy;
        const windowId = browserConnection.activeWindowId;
        const taskScript = await browserConnection.currentJob.currentTestRun.session.getTaskScript({
            referer: '',
            cookieUrl: '',
            isIframe: false,
            withPayload: true,
            serverInfo: proxy.server1Info,
            windowId,
        });
        const injectableResources = {
            stylesheets: [
                injectables_1.TESTCAFE_UI_STYLES,
            ],
            scripts: [
                ...testcafe_hammerhead_1.INJECTABLE_SCRIPTS,
                ...injectables_1.SCRIPTS,
            ],
            embeddedScripts: [taskScript],
        };
        injectableResources.scripts = injectableResources.scripts.map(script => proxy.resolveRelativeServiceUrl(script));
        injectableResources.stylesheets = injectableResources.stylesheets.map(style => proxy.resolveRelativeServiceUrl(style));
        return injectableResources;
    }
    _processResponseHeaders(headers) {
        if (!headers)
            return [];
        (0, lodash_1.remove)(headers, header => CONTENT_SECURITY_POLICY_HEADER_NAMES.includes(header.name));
        return headers;
    }
    async _handleHTTPPages(client) {
        await client.Fetch.enable({ patterns: [ALL_DOCUMENT_RESPONSES] });
        client.Fetch.on('requestPaused', async (params) => {
            const { requestId, responseHeaders, responseStatusCode, } = params;
            if (this._isServicePage(params.request.url))
                await client.Fetch.continueRequest({ requestId });
            else {
                const responseObj = await client.Fetch.getResponseBody({ requestId });
                const responseStr = this._getResponseAsString(responseObj);
                const injectableResources = await this._prepareInjectableResources();
                const updatedResponseStr = (0, testcafe_hammerhead_1.injectResources)(responseStr, injectableResources);
                await client.Fetch.fulfillRequest({
                    requestId,
                    responseCode: responseStatusCode || HTTP_STATUS_OK,
                    responseHeaders: this._processResponseHeaders(responseHeaders),
                    body: Buffer.from(updatedResponseStr).toString('base64'),
                });
            }
        });
    }
    _topFrameNavigationToAboutBlank(event) {
        if (event.frame.url !== testcafe_hammerhead_1.SPECIAL_BLANK_PAGE)
            return false;
        if (event.type !== 'Navigation')
            return false;
        if (event.frame.parentId)
            return false;
        return true;
    }
    async _handleAboutBlankPage(client) {
        await client.Page.enable();
        client.Page.on('frameNavigated', async (params) => {
            if (!this._topFrameNavigationToAboutBlank(params))
                return;
            const injectableResources = await this._prepareInjectableResources();
            const html = (0, testcafe_hammerhead_1.injectResources)(about_blank_page_markup_1.default, injectableResources);
            await client.Page.setDocumentContent({
                frameId: params.frame.id,
                html,
            });
        });
    }
    async setup(client) {
        await this._handleHTTPPages(client);
        await this._handleAboutBlankPage(client);
    }
}
exports.default = ResourceInjector;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UtaW5qZWN0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcHJveHlsZXNzL3Jlc291cmNlLWluamVjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBT0EsNkRBSzZCO0FBQzdCLHVFQUFzRDtBQUN0RCx1REFBb0U7QUFDcEUsd0ZBQWdFO0FBQ2hFLG1DQUFnQztBQUVoQyxNQUFNLGNBQWMsR0FBRyxHQUFHLENBQUM7QUFFM0IsTUFBTSxzQkFBc0IsR0FBRztJQUMzQixVQUFVLEVBQUksR0FBRztJQUNqQixZQUFZLEVBQUUsVUFBVTtJQUN4QixZQUFZLEVBQUUsVUFBVTtDQUNULENBQUM7QUFFcEIsTUFBTSxvQ0FBb0MsR0FBRztJQUN6Qyx5QkFBeUI7SUFDekIscUNBQXFDO0NBQ3hDLENBQUM7QUFFRixNQUFxQixnQkFBZ0I7SUFHakMsWUFBb0IsU0FBaUI7UUFDakMsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7SUFDaEMsQ0FBQztJQUVPLG9CQUFvQixDQUFFLFFBQWlDO1FBQzNELE9BQU8sUUFBUSxDQUFDLGFBQWE7WUFDekIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxRQUFRLEVBQUU7WUFDakQsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVPLGNBQWMsQ0FBRSxHQUFXO1FBQy9CLE1BQU0saUJBQWlCLEdBQUcsb0JBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQXNCLENBQUM7UUFDMUYsTUFBTSxLQUFLLEdBQWUsaUJBQWlCLENBQUMsd0JBQXdCLENBQUMsS0FBSyxDQUFDO1FBRTNFLE9BQU8sR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFFTyxLQUFLLENBQUMsMkJBQTJCO1FB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QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzdDLENBQUM7Q0FDSjtBQTFIRCxtQ0EwSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcm90b2NvbEFwaSB9IGZyb20gJ2Nocm9tZS1yZW1vdGUtaW50ZXJmYWNlJztcbmltcG9ydCBQcm90b2NvbCBmcm9tICdkZXZ0b29scy1wcm90b2NvbCc7XG5pbXBvcnQgUmVxdWVzdFBhdXNlZEV2ZW50ID0gUHJvdG9jb2wuRmV0Y2guUmVxdWVzdFBhdXNlZEV2ZW50O1xuaW1wb3J0IFJlcXVlc3RQYXR0ZXJuID0gUHJvdG9jb2wuRmV0Y2guUmVxdWVzdFBhdHRlcm47XG5pbXBvcnQgR2V0UmVzcG9uc2VCb2R5UmVzcG9uc2UgPSBQcm90b2NvbC5GZXRjaC5HZXRSZXNwb25zZUJvZHlSZXNwb25zZTtcbmltcG9ydCBGcmFtZU5hdmlnYXRlZEV2ZW50ID0gUHJvdG9jb2wuUGFnZS5GcmFtZU5hdmlnYXRlZEV2ZW50O1xuaW1wb3J0IEhlYWRlckVudHJ5ID0gUHJvdG9jb2wuRmV0Y2guSGVhZGVyRW50cnk7XG5pbXBvcnQge1xuICAgIGluamVjdFJlc291cmNlcyxcbiAgICBQYWdlSW5qZWN0YWJsZVJlc291cmNlcyxcbiAgICBJTkpFQ1RBQkxFX1NDUklQVFMgYXMgSEFNTUVSSEVBRF9JTkpFQ1RBQkxFX1NDUklQVFMsXG4gICAgU1BFQ0lBTF9CTEFOS19QQUdFLFxufSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCBCcm93c2VyQ29ubmVjdGlvbiBmcm9tICcuLi9icm93c2VyL2Nvbm5lY3Rpb24nO1xuaW1wb3J0IHsgU0NSSVBUUywgVEVTVENBRkVfVUlfU1RZTEVTIH0gZnJvbSAnLi4vYXNzZXRzL2luamVjdGFibGVzJztcbmltcG9ydCBBQk9VVF9CTEFOS19QQUdFX01BUktVUCBmcm9tICcuL2Fib3V0LWJsYW5rLXBhZ2UtbWFya3VwJztcbmltcG9ydCB7IHJlbW92ZSB9IGZyb20gJ2xvZGFzaCc7XG5cbmNvbnN0IEhUVFBfU1RBVFVTX09LID0gMjAwO1xuXG5jb25zdCBBTExfRE9DVU1FTlRfUkVTUE9OU0VTID0ge1xuICAgIHVybFBhdHRlcm46ICAgJyonLFxuICAgIHJlc291cmNlVHlwZTogJ0RvY3VtZW50JyxcbiAgICByZXF1ZXN0U3RhZ2U6ICdSZXNwb25zZScsXG59IGFzIFJlcXVlc3RQYXR0ZXJuO1xuXG5jb25zdCBDT05URU5UX1NFQ1VSSVRZX1BPTElDWV9IRUFERVJfTkFNRVMgPSBbXG4gICAgJ2NvbnRlbnQtc2VjdXJpdHktcG9saWN5JyxcbiAgICAnY29udGVudC1zZWN1cml0eS1wb2xpY3ktcmVwb3J0LW9ubHknLFxuXTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVzb3VyY2VJbmplY3RvciB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfYnJvd3NlcklkOiBzdHJpbmc7XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKGJyb3dzZXJJZDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuX2Jyb3dzZXJJZCA9IGJyb3dzZXJJZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRSZXNwb25zZUFzU3RyaW5nIChyZXNwb25zZTogR2V0UmVzcG9uc2VCb2R5UmVzcG9uc2UpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuYmFzZTY0RW5jb2RlZFxuICAgICAgICAgICAgPyBCdWZmZXIuZnJvbShyZXNwb25zZS5ib2R5LCAnYmFzZTY0JykudG9TdHJpbmcoKVxuICAgICAgICAgICAgOiByZXNwb25zZS5ib2R5O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2lzU2VydmljZVBhZ2UgKHVybDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGJyb3dzZXJDb25uZWN0aW9uID0gQnJvd3NlckNvbm5lY3Rpb24uZ2V0QnlJZCh0aGlzLl9icm93c2VySWQpIGFzIEJyb3dzZXJDb25uZWN0aW9uO1xuICAgICAgICBjb25zdCBwcm94eSAgICAgICAgICAgICA9IGJyb3dzZXJDb25uZWN0aW9uLmJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5wcm94eTtcblxuICAgICAgICByZXR1cm4gdXJsLnN0YXJ0c1dpdGgocHJveHkuc2VydmVyMUluZm8uZG9tYWluKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9wcmVwYXJlSW5qZWN0YWJsZVJlc291cmNlcyAoKTogUHJvbWlzZTxQYWdlSW5qZWN0YWJsZVJlc291cmNlcz4ge1xuICAgICAgICBjb25zdCBicm93c2VyQ29ubmVjdGlvbiA9IEJyb3dzZXJDb25uZWN0aW9uLmdldEJ5SWQodGhpcy5fYnJvd3NlcklkKSBhcyBCcm93c2VyQ29ubmVjdGlvbjtcbiAgICAgICAgY29uc3QgcHJveHkgICAgICAgICAgICAgPSBicm93c2VyQ29ubmVjdGlvbi5icm93c2VyQ29ubmVjdGlvbkdhdGV3YXkucHJveHk7XG4gICAgICAgIGNvbnN0IHdpbmRvd0lkICAgICAgICAgID0gYnJvd3NlckNvbm5lY3Rpb24uYWN0aXZlV2luZG93SWQ7XG5cbiAgICAgICAgY29uc3QgdGFza1NjcmlwdCA9IGF3YWl0IGJyb3dzZXJDb25uZWN0aW9uLmN1cnJlbnRKb2IuY3VycmVudFRlc3RSdW4uc2Vzc2lvbi5nZXRUYXNrU2NyaXB0KHtcbiAgICAgICAgICAgIHJlZmVyZXI6ICAgICAnJyxcbiAgICAgICAgICAgIGNvb2tpZVVybDogICAnJyxcbiAgICAgICAgICAgIGlzSWZyYW1lOiAgICBmYWxzZSxcbiAgICAgICAgICAgIHdpdGhQYXlsb2FkOiB0cnVlLFxuICAgICAgICAgICAgc2VydmVySW5mbzogIHByb3h5LnNlcnZlcjFJbmZvLFxuICAgICAgICAgICAgd2luZG93SWQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGluamVjdGFibGVSZXNvdXJjZXMgPSB7XG4gICAgICAgICAgICBzdHlsZXNoZWV0czogW1xuICAgICAgICAgICAgICAgIFRFU1RDQUZFX1VJX1NUWUxFUyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBzY3JpcHRzOiBbXG4gICAgICAgICAgICAgICAgLi4uSEFNTUVSSEVBRF9JTkpFQ1RBQkxFX1NDUklQVFMsXG4gICAgICAgICAgICAgICAgLi4uU0NSSVBUUyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBlbWJlZGRlZFNjcmlwdHM6IFt0YXNrU2NyaXB0XSxcbiAgICAgICAgfTtcblxuICAgICAgICBpbmplY3RhYmxlUmVzb3VyY2VzLnNjcmlwdHMgICAgID0gaW5qZWN0YWJsZVJlc291cmNlcy5zY3JpcHRzLm1hcChzY3JpcHQgPT4gcHJveHkucmVzb2x2ZVJlbGF0aXZlU2VydmljZVVybChzY3JpcHQpKTtcbiAgICAgICAgaW5qZWN0YWJsZVJlc291cmNlcy5zdHlsZXNoZWV0cyA9IGluamVjdGFibGVSZXNvdXJjZXMuc3R5bGVzaGVldHMubWFwKHN0eWxlID0+IHByb3h5LnJlc29sdmVSZWxhdGl2ZVNlcnZpY2VVcmwoc3R5bGUpKTtcblxuICAgICAgICByZXR1cm4gaW5qZWN0YWJsZVJlc291cmNlcztcbiAgICB9XG5cbiAgICBwcml2YXRlIF9wcm9jZXNzUmVzcG9uc2VIZWFkZXJzIChoZWFkZXJzOiBIZWFkZXJFbnRyeVtdIHwgdW5kZWZpbmVkKTogSGVhZGVyRW50cnlbXSB7XG4gICAgICAgIGlmICghaGVhZGVycylcbiAgICAgICAgICAgIHJldHVybiBbXTtcblxuICAgICAgICByZW1vdmUoaGVhZGVycywgaGVhZGVyID0+IENPTlRFTlRfU0VDVVJJVFlfUE9MSUNZX0hFQURFUl9OQU1FUy5pbmNsdWRlcyhoZWFkZXIubmFtZSkpO1xuXG4gICAgICAgIHJldHVybiBoZWFkZXJzO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2hhbmRsZUhUVFBQYWdlcyAoY2xpZW50OiBQcm90b2NvbEFwaSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCBjbGllbnQuRmV0Y2guZW5hYmxlKHsgcGF0dGVybnM6IFtBTExfRE9DVU1FTlRfUkVTUE9OU0VTXSB9KTtcblxuICAgICAgICBjbGllbnQuRmV0Y2gub24oJ3JlcXVlc3RQYXVzZWQnLCBhc3luYyAocGFyYW1zOiBSZXF1ZXN0UGF1c2VkRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlU3RhdHVzQ29kZSxcbiAgICAgICAgICAgIH0gPSBwYXJhbXM7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLl9pc1NlcnZpY2VQYWdlKHBhcmFtcy5yZXF1ZXN0LnVybCkpXG4gICAgICAgICAgICAgICAgYXdhaXQgY2xpZW50LkZldGNoLmNvbnRpbnVlUmVxdWVzdCh7IHJlcXVlc3RJZCB9KTtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlT2JqICAgICAgICAgPSBhd2FpdCBjbGllbnQuRmV0Y2guZ2V0UmVzcG9uc2VCb2R5KHsgcmVxdWVzdElkIH0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlU3RyICAgICAgICAgPSB0aGlzLl9nZXRSZXNwb25zZUFzU3RyaW5nKHJlc3BvbnNlT2JqKTtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmplY3RhYmxlUmVzb3VyY2VzID0gYXdhaXQgdGhpcy5fcHJlcGFyZUluamVjdGFibGVSZXNvdXJjZXMoKTtcbiAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGVkUmVzcG9uc2VTdHIgID0gaW5qZWN0UmVzb3VyY2VzKHJlc3BvbnNlU3RyLCBpbmplY3RhYmxlUmVzb3VyY2VzKTtcblxuICAgICAgICAgICAgICAgIGF3YWl0IGNsaWVudC5GZXRjaC5mdWxmaWxsUmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VDb2RlOiAgICByZXNwb25zZVN0YXR1c0NvZGUgfHwgSFRUUF9TVEFUVVNfT0ssXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVyczogdGhpcy5fcHJvY2Vzc1Jlc3BvbnNlSGVhZGVycyhyZXNwb25zZUhlYWRlcnMpLFxuICAgICAgICAgICAgICAgICAgICBib2R5OiAgICAgICAgICAgIEJ1ZmZlci5mcm9tKHVwZGF0ZWRSZXNwb25zZVN0cikudG9TdHJpbmcoJ2Jhc2U2NCcpLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF90b3BGcmFtZU5hdmlnYXRpb25Ub0Fib3V0QmxhbmsgKGV2ZW50OiBGcmFtZU5hdmlnYXRlZEV2ZW50KTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChldmVudC5mcmFtZS51cmwgIT09IFNQRUNJQUxfQkxBTktfUEFHRSlcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICBpZiAoZXZlbnQudHlwZSAhPT0gJ05hdmlnYXRpb24nKVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIGlmIChldmVudC5mcmFtZS5wYXJlbnRJZClcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9oYW5kbGVBYm91dEJsYW5rUGFnZSAoY2xpZW50OiBQcm90b2NvbEFwaSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCBjbGllbnQuUGFnZS5lbmFibGUoKTtcblxuICAgICAgICBjbGllbnQuUGFnZS5vbignZnJhbWVOYXZpZ2F0ZWQnLCBhc3luYyAocGFyYW1zOiBGcmFtZU5hdmlnYXRlZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX3RvcEZyYW1lTmF2aWdhdGlvblRvQWJvdXRCbGFuayhwYXJhbXMpKVxuICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgY29uc3QgaW5qZWN0YWJsZVJlc291cmNlcyA9IGF3YWl0IHRoaXMuX3ByZXBhcmVJbmplY3RhYmxlUmVzb3VyY2VzKCk7XG4gICAgICAgICAgICBjb25zdCBodG1sICAgICAgICAgICAgICAgID0gaW5qZWN0UmVzb3VyY2VzKEFCT1VUX0JMQU5LX1BBR0VfTUFSS1VQLCBpbmplY3RhYmxlUmVzb3VyY2VzKTtcblxuICAgICAgICAgICAgYXdhaXQgY2xpZW50LlBhZ2Uuc2V0RG9jdW1lbnRDb250ZW50KHtcbiAgICAgICAgICAgICAgICBmcmFtZUlkOiBwYXJhbXMuZnJhbWUuaWQsXG4gICAgICAgICAgICAgICAgaHRtbCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgc2V0dXAgKGNsaWVudDogUHJvdG9jb2xBcGkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5faGFuZGxlSFRUUFBhZ2VzKGNsaWVudCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX2hhbmRsZUFib3V0QmxhbmtQYWdlKGNsaWVudCk7XG4gICAgfVxufVxuIl19